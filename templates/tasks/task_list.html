{% extends "base.html" %}
{% block title %}Tasks · Student Tasking{% endblock %}

{% block content %}
<div class="d-flex align-items-center justify-content-between mb-3">
  <h1 class="h3 mb-0">Tasks</h1>
  <a class="btn btn-primary" href="{% url 'tasks:task_create' %}">+ New task</a>
</div>

<form method="get" class="card card-body mb-3">
  <div class="row g-2 align-items-end">
    <div class="col-md-4">
      <label class="form-label mb-1">Search</label>
      <input class="form-control" type="text" name="q" value="{{ filters.q }}" placeholder="Title, course, description…">
    </div>

    <div class="col-md-2">
      <label class="form-label mb-1">Status</label>
      <select class="form-select" name="status">
        <option value="">Any</option>
        {% for value,label in status_choices %}
          <option value="{{ value }}" {% if filters.status == value %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-2">
      <label class="form-label mb-1">Priority</label>
      <select class="form-select" name="priority">
        <option value="">Any</option>
        {% for value,label in priority_choices %}
          <option value="{{ value }}" {% if filters.priority == value %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-2">
      <label class="form-label mb-1">Course</label>
      <select class="form-select" name="course">
        <option value="">Any</option>
        {% for c in courses %}
          <option value="{{ c.id }}" {% if filters.course|add:'' == c.id|add:'' %}selected{% endif %}>{{ c.name }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-2">
      <label class="form-label mb-1">Due</label>
      <select class="form-select" name="due">
        <option value="">Any</option>
        <option value="overdue" {% if filters.due == 'overdue' %}selected{% endif %}>Overdue</option>
        <option value="today" {% if filters.due == 'today' %}selected{% endif %}>Today</option>
        <option value="soon" {% if filters.due == 'soon' %}selected{% endif %}>Next 3 days</option>
      </select>
    </div>

    <div class="col-12 d-flex gap-2 mt-2">
      <button class="btn btn-outline-primary" type="submit">Apply</button>
      <a class="btn btn-outline-secondary" href="{% url 'tasks:task_list' %}">Clear</a>
    </div>
  </div>
</form>

<div class="card">
  <div class="table-responsive">
    <table class="table table-hover align-middle mb-0">
      <thead class="table-light">
        <tr>
          <th style="width: 44%">Task</th>
          <th>Course</th>
          <th>Due</th>
          <th>Status</th>
          <th>Priority</th>
          <th style="width: 140px">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for task in tasks %}
          <tr>
            <td>
              <a class="text-decoration-none task-title" href="{% url 'tasks:task_detail' task.pk %}">
                {{ task.title }}
              </a>
              {% if task.tags.all %}
                <div class="mt-1">
                  {% for tag in task.tags.all %}
                    <span class="badge text-bg-secondary">{{ tag.name }}</span>
                  {% endfor %}
                </div>
              {% endif %}
              {% if task.description %}
                <div class="text-muted small mt-1">{{ task.description|truncatechars:120 }}</div>
              {% endif %}
            </td>
            <td>
              {% if task.course %}
                <span class="badge-dot" style="background: {{ task.course.color }}"></span>
                {{ task.course.name }}
              {% else %}
                <span class="text-muted">—</span>
              {% endif %}
            </td>
            <td>
              {% if task.due_at %}
                <span class="{% if task.is_overdue %}text-danger{% endif %}">
                  {{ task.due_at|date:"Y-m-d H:i" }}
                </span>
              {% else %}
                <span class="text-muted">—</span>
              {% endif %}
            </td>
            <td>
              {% if task.status == 'DONE' %}
                <span class="badge text-bg-success">{{ task.get_status_display }}</span>
              {% elif task.status == 'INPR' %}
                <span class="badge text-bg-warning">{{ task.get_status_display }}</span>
              {% else %}
                <span class="badge text-bg-light text-dark">{{ task.get_status_display }}</span>
              {% endif %}
            </td>
            <td>
              {% if task.priority == 'URG' %}
                <span class="badge text-bg-danger">{{ task.get_priority_display }}</span>
              {% elif task.priority == 'HIGH' %}
                <span class="badge text-bg-warning">{{ task.get_priority_display }}</span>
              {% else %}
                <span class="badge text-bg-secondary">{{ task.get_priority_display }}</span>
              {% endif %}
            </td>
            <td>
              <div class="d-flex gap-2">
                <a class="btn btn-sm btn-outline-secondary" href="{% url 'tasks:task_update' task.pk %}">Edit</a>
                <form method="post" action="{% url 'tasks:task_toggle_done' task.pk %}">
                  {% csrf_token %}
                  <input type="hidden" name="next" value="{{ request.get_full_path }}">
                  {% if task.status == 'DONE' %}
                    <button class="btn btn-sm btn-outline-success" type="submit">Undone</button>
                  {% else %}
                    <button class="btn btn-sm btn-outline-success" type="submit">Done</button>
                  {% endif %}
                </form>
              </div>
            </td>
          </tr>
        {% empty %}
          <tr><td colspan="6" class="text-muted p-4">No tasks match your filters.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

{% if is_paginated %}
  <nav class="mt-3">
    <ul class="pagination">
      {% if page_obj.has_previous %}
        <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}">Previous</a></li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">Previous</span></li>
      {% endif %}

      <li class="page-item disabled"><span class="page-link">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span></li>

      {% if page_obj.has_next %}
        <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}">Next</a></li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">Next</span></li>
      {% endif %}
    </ul>
  </nav>
{% endif %}
{% endblock %}
